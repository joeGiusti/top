<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css" />


    <!-- firebase setup scripts -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
    <--https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-auth.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDsTg4EJafxi4Y60ozzP7BQiOm-036UrDo",
            authDomain: "unity-test-29bde.firebaseapp.com",
            databaseURL: "https://unity-test-29bde.firebaseio.com",
            projectId: "unity-test-29bde",
            storageBucket: "unity-test-29bde.appspot.com",
            messagingSenderId: "323632391835",
            appId: "1:323632391835:web:8d5a202336c41b319b483e",
            measurementId: "G-YMJME22WL0"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
    </script>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


    <link rel="icon" href="torch2Icon.png" />
    <title id="title">Home</title>
</head>
<body>

    <!-- topnav -->
    <div class="topnav">
        <!-- user account dropdown
        <object class="dropdown">
            <img class="userIcon" src="userIcon.png">
            <div class="dropdown-content">
                <div id="accountButton">Account</div><br id="toggle" />
                <div id="signoutButton">Logout</div><br id="toggle2" />
                <div id="signinButton" data-toggle="modal" data-target="#signInModal">Sign In</div><br />
                <div id="signupButton" data-toggle="modal" data-target="#signUpModal">Sign Up</div><br />
                <div id="anonButton">Anonomous</div>
            </div>
        </object>
        <div class="topSide">TOP</div>-->
    </div>
    <!-- dropdown user buttons -->
    <div class="dropdown" style="position:absolute; top:0; right:0; height:50px; width:200px;">
        <img class="userIcon" src="userIcon.png" style="height:50px; position:absolute; right:10px;">
        <div id="ddc" class="dropdown-content2" style="opacity:1;">
            <div class="hideToggle" id="homeButton">Home</div>
            <div class="hideToggle" id="accountButton">Account</div>
            <div class="hideToggle" id="signoutButton">Logout</div>
            <div class="hideToggle" id="signinButton" data-toggle="modal" data-target="#signInModal">Sign In</div>
            <div class="hideToggle" id="signupButton" data-toggle="modal" data-target="#signUpModal">Sign Up</div>
            <div class="hideToggle" id="anonButton">Anonomous</div>
        </div>
    </div>
    <!-- Sign In Modal -->
    <div class="modal fade" id="signInModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="height:100%;">
        <div class="modal-dialog" role="document" style="height:100%;">
            <div class="modal-content modalContent1" style="top: 30%;">
                <div class="modal-header">
                    <p style="text-align:center; color:white; font-size:20px; font-weight:bold; width:100%;">
                        User Login
                    </p>
                </div>
                <div class="modal-body">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="User" style="color:white;">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Pass" style="color:white;">
                </div>
                <div class="modal-footer" style="height:80px;">
                    <button type="button" class="modalButton left" data-dismiss="modal">Cancel</button>
                    <button type="button" class="modalButton right">Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div class="modal fade" id="signUpModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="height:100%;">
        <div class="modal-dialog" role="document" style="height:100%;">
            <div class="modal-content modalContent2">
                <div class="modal-header">
                    <p style="text-align:center; color:white; font-size:20px; font-weight:bold; width:100%;">
                        New User
                    </p>
                </div>
                <div class="modal-body">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Login Name" style="color:white;">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Password" style="color:white;">
                    <div class="modal-header"></div>
                    <p style="color:white; font-size:15px; text-align:center; font-weight:bold; padding:10px;">
                        * Optional *
                    </p>
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Email (for recovery)" style="color:white;">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Student ID" style="color:white;">
                </div>
                <div class="modal-footer" style="height:80px;">
                    <button type="button" class="modalButton left" data-dismiss="modal">Cancel</button>
                    <button type="button" class="modalButton right">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Class modal -->
    <div class="modal fade" id="searchClassModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="height:100%;">
        <div class="modal-dialog" role="document" style="height:100%;">
            <div class="modal-content modalContent2">
                <div class="modal-header">
                    <p style="text-align:center; color:white; font-size:20px; font-weight:bold; width:100%;">
                        Search Classes
                    </p>
                </div>
                <div class="modal-body">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Class ID" style="color:white;">
                    <p style="color:white; font-weight:bold; text-align:center; font-size:20px;">or</p>
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Class Name" style="color:white;">
                    <p style="color:white; font-weight:bold; text-align:center; font-size:20px;">or</p>
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Teacher Name" style="color:white;">
                    <p style="color:white; font-weight:bold; text-align:center; font-size:20px;">or</p>
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Subject" style="color:white;">
                </div>
                <div class="modal-footer" style="height:80px;">
                    <button type="button" class="modalButton left" data-dismiss="modal">Cancel</button>
                    <button type="button" class="modalButton right">Search</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create A Class modal -->
    <div class="modal fade" id="createClassModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="height:100%;">
        <div class="modal-dialog" role="document" style="height:100%;">
            <div class="modal-content modalContent2" style="top: 20%;">
                <div class="modal-header">
                    <p style="text-align:center; color:white; font-size:20px; font-weight:bold; width:100%;">
                        Create A Class
                    </p>
                </div>
                <div class="modal-body">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Class Name" style="color:white;">
                    <input id="signupEmailInput" autocomplete="off" class="input100" type="text" name="username" placeholder="Subject" style="color:white; ">
                    <br />
                    <textarea class="input100" placeholder="Description" style="color:white; height:120px;"></textarea>
                </div>
                <div class="modal-footer" style="height:80px;">
                    <button type="button" class="modalButton left" data-dismiss="modal">Cancel</button>
                    <button type="button" class="modalButton right">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- sidebar -->
    <div class="sidenav" id="sidenavID" style="position:fixed; top:0;">
        <div style="width:200px; height:50px;     background-color: #00182D;"></div>
        <a id="homeSideButton" href="home.html">Home</a>
        <a id="classesSideButton" href="classPage.html">Classes</a>
        <a id="labsSideButton">Labs</a>
        <a id="modulesSideButton">Guided studies</a>
        <a id="gradesSideButton">Grades</a>
        <a id="settingsSideButton">Settings</a>
        <img class="backgroundImage" src="torch2.jpg" />

    </div>

    <!-- welcomebar -->
    <div id="welcomeDiv" class="mid" ">
        <p id="welcomeBar" style="font-size:35px;">Welcome</p>
    </div>
    <hr />

    <!-- home content -->
    <div class="midHolder" id="homeDiv">





        <!-- classes -->
        <div id="classDiv" class="mid">
            <h1 class="text-center">Open Classes</h1>
            <div id="classesPlaceholder">~ classes will show here ~</div>
            <div id="classesDiv"></div>
            <br />
            <button type="button" class="pageButton">Browse Classes</button>
            <button type="button" class="pageButton" data-toggle="modal" data-target="#createClassModal">Create A Class</button>
            <button type="button" class="pageButton" data-toggle="modal" data-target="#searchClassModal">Search Classes</button>
        </div>
        <hr />
        <div id="classDiv" class="mid">
            <h1 class="text-center">Complete Classes</h1>
            <div id="classesPlaceholder">~ complete classes will show here ~</div>
        </div>
        <hr />
    </div>

    <div id="hat" class="midHolder" style="display:none;">
        <!-- open labs for this class -->
        <div id="classLabsDiv" class="mid">
            <h1 class="text-center">Open Labs</h1>

            <div id="classLabsPlaceholder">~ open labs will show here ~</div>
            <div id="classLabsDiv"></div>
        </div>
        <hr />
        <!-- open sessions for this class -->
        <div id="classSessionsDiv" class="mid">
            <h1 class="text-center">open Sessions</h1>

            <div id="classSessionsPlaceholder">~ open labs will show here ~</div>
            <div id="classSessionsDiv"></div>
        </div>
        <hr />

        <!-- open guided study for this class -->
        <div id="classModulesDiv" class="mid">
            <h1 class="text-center">Open Guided Study Modules</h1>

            <div id="classModulesPlaceholder">~ guided study modules will show here ~</div>
            <div id="classModulesDiv"></div>
        </div>
        <hr />
    </div>

    <script>

        var name;
        var classIds = [];
        var userRef;
        var isAnonymous;


        //document.getElementById("classesSideButton").style.backgroundColor = "#2A5C99";
        getAuth();

        $("#sidenavID").on("scroll", function (e) {

            if (this.scrollTOP > 50)
                console.log("over");
        });

        $("#accountButton").click(function () {
            console.log("clicked accountButton");
        });
        $("#signoutButton").click(function () {
            firebase.auth().signOut();
            console.log("clicked signoutButton");
        });
        $("#signinButton").click(function () {
            console.log("clicked signinButton");
        });
        $("#signupButton").click(function () {
            console.log("clicked signupButton");
        });
        $("#anonButton").click(function () {
            console.log("clicked anonButton");
            firebase.auth().signInAnonymously().catch(function (error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
            });
        });


        // get auth
        function getAuth() {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {

                    // only show the relivant buttons in the user dropdown
                    userButtons();

                    isAnonymous = user.isAnonymous;
                    if (isAnonymous == true) {
                        console.log("loged in as anon");
                    }

                    // get a ref to the user to get their id
                    userRef = firebase.database().ref().child('structA').child('users').child(user.uid);

                    if (isAnonymous) {
                        setWelcomeBar("Anonymous User")
                    }
                    else {
                        // get the users name for the welcome bar
                        userRef.child("name").once("value", function (snap) { name = snap.val() });
                        setWelcomeBar(name);
                    }




                    // load the users list of class ids
                    loadClassesFromUser(userRef);
                } else {
                    window.location.href = 'index.html';
                    noUserButtons();
                }
            });
        }
        function userButtons() {


            document.getElementById("signoutButton").style.display = "block";
            document.getElementById("accountButton").style.display = "block";
            document.getElementById("signinButton").style.visibility = "none";
            document.getElementById("signupButton").style.visibility = "none";
            document.getElementById("anonButton").style.visibility = "none";


            document.getElementById("signoutButton").style.visibility = "visible";
            document.getElementById("accountButton").style.visibility = "visible";
            document.getElementById("signinButton").style.visibility = "hidden";
            document.getElementById("signupButton").style.visibility = "hidden";
            document.getElementById("anonButton").style.visibility = "hidden";
            document.getElementById("ddc").style.height = "140px";
            console.log("logged in");
        }
        function noUserButtons() {
            //document.getElementById("signoutButton").style.position = "absolute";
            //document.getElementById("accountButton").style.position = "absolute";
            //document.getElementById("accountButton").innerHTML = "";

            document.getElementById("signoutButton").style.display = "none";
            document.getElementById("accountButton").style.display = "none";
            document.getElementById("signinButton").style.visibility = "block";
            document.getElementById("signupButton").style.visibility = "block";
            document.getElementById("anonButton").style.visibility = "block";


            document.getElementById("signoutButton").style.visibility = "hidden";
            document.getElementById("accountButton").style.visibility = "hidden";
            document.getElementById("signinButton").style.visibility = "visible";
            document.getElementById("signupButton").style.visibility = "visible";
            document.getElementById("anonButton").style.visibility = "visible";
            document.getElementById("ddc").style.height = "140px";
            console.log("logged out");
        }
        function setWelcomeBar(name) {
            document.getElementById("welcomeBar").innerHTML = "welcome " + name;
        }
        $("#homeButton").click(function () {
            window.location.href = "home.html";
        });

        function loadClassesFromUser(ref) {
            ref.child("classes").once("value", function (snapshot) {
                snapshot.forEach(function (c) {
                    //console.log(c.val());
                    //showClass(c.val());
                    classIds.push(c.key);
                });
                // use the array after it has been retrieved
                useClassRefArray();
            });
        }
        function useClassRefArray(classId) {
            classIds.forEach(function (classId) {
                removeOld(classId);
                firebase.database().ref().child("structA").child("classes").child(classId).on("value", function (snap) {
                    removeOld(classId);
                    // add this class to the html
                    addClassHtml(snap.child("name").val(), snap.child("description").val(), snap.child("imageUrl").val(), classId);

                    // add the labs for this class to the html
                    snap.child("labs").forEach(function (lab) {
                        console.log(lab.key);
                        if (lab.child("active").val() == "true") {
                            addLabHtml(lab.child("name").val(), lab.child("description").val(), lab.child("imageUrl").val(), lab.child("labUrl").val(), classId);
                        }
                    });

                    // load the sessions
                    snap.child("sessions").forEach(function (session) {
                        console.log("a? = " + session.child("active").val());
                        if (session.child("active").val() == "true")
                            addSessionHtml(session.child("name").val(), session.child("description").val(), classId, session.key);
                    });
                });
            });
        }
        function removeOld(classIdClass) {
            console.log("removing all with class " + classIdClass);
            $('.' + classIdClass).remove();
        }
        // add the html for the given data
        function addClassHtml(name, description, imageUrl, classId) {
            // put the html code here and += it to the proper spot
            document.getElementById("classesPlaceholder").innerHTML = "";


            var newCard = '' +
                '<div class="card ' + classId + '" style="width: 18rem; margin:20px; display:inline-block;">' +
                '<img src="' + imageUrl + '" class="card-img-top" alt="...">' +
                '<div class="card-body">' +
                '<h5 class="card-title">' + name + '</h5>' +
                '<p class="card-text">' + description + '</p>' +
                '<button onClick="openClass(\'' + classId + '\')" class="btn btn-primary"> <a style="color:white;" href="#" >Open Class</a></button>' +
                '</div>' +
                '</div>';
            document.getElementById("classesDiv").innerHTML += newCard;

        }
        function addSessionHtml(name, description, classId, sessionId) {
            // put the html code here and += it to the proper spot
            document.getElementById("sessionsPlaceholder").innerHTML = "";
            var newCard = '' +
                '<div class="card ' + classId + '" style="width: 18rem; margin:20px; display:inline-block;">' +
                '<div class="card-body">' +
                '<h5 class="card-title">' + name + '</h5>' +
                '<p class="card-text">' + description + '</p>' +
                // " will start and end the onClick area, ' will start and end the html literal, \' will be seen as ' in the html
                '<button onClick="goToSession(\'' + sessionId + '\',\'' + classId + '\')" class="btn btn-primary">Open Session</button>' +
                //'<button onClick="openLab(\'' + labUrl + '\')" class="btn btn-primary">Open Lab</button>' +

                '</div>' +
                '</div>';
            document.getElementById("sessionsDiv").innerHTML += newCard;
        }
        function addLabHtml(name, description, imageUrl, labUrl, classId) {
            // put the html code here and += it to the proper spot
            document.getElementById("labsPlaceholder").innerHTML = "";
            var newCard = '' +
                '<div class="card ' + classId + '" style="width: 18rem; margin:20px; display:inline-block;">' +
                '<img src="' + imageUrl + '" class="card-img-top" alt="...">' +
                '<div class="card-body">' +
                '<h5 class="card-title">' + name + '</h5>' +
                '<p class="card-text">' + description + '</p>' +
                '<button onClick="openLab(\'' + labUrl + '\')" class="btn btn-primary">Open Lab</button>' +
                '</div>' +
                '</div>';
            document.getElementById("labsDiv").innerHTML += newCard;
        }
        var currentClassId;
        function openClass(classId) {
            currentClassId = classId;
            console.log("opening " + classId);
            //ghs2() (this is the sound)

            // change the title
            document.getElementById("title").innerHTML = "Class Home";

            // set all home elements to invisible
            document.getElementById("homeDiv").style.display = "none";
            //document.getElementById("homeSideButton").add style.backgroundColor = "#01284A";

            // show all class page elements
            document.getElementById("hat").style.backgroundColor = "red";
            document.getElementById("hat").style.display = "block";
            //document.getElementById("classesSideButton").style.backgroundColor = "#2A5C99";
            $("#classesSideButton").removeClass("active");
            // load all class data

        }
    </script>
</body>
</html>